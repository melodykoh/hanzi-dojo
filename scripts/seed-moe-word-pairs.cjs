#!/usr/bin/env node
/**
 * Seed word_pairs table with MOE (教育部重編國語辭典) 2-character word pairs.
 *
 * - Reads from data/moe_word_pairs.json (generated by extract-moe-word-pairs.cjs)
 * - Upserts into word_pairs with ON CONFLICT (word) DO NOTHING
 * - Sets category = NULL to distinguish from CCCC pairs (which have category set)
 * - Safe to re-run: skips existing words
 *
 * Run: node --env-file=.env.local scripts/seed-moe-word-pairs.cjs
 */

const { createClient } = require('@supabase/supabase-js');
const fs = require('fs');
const path = require('path');

async function seedMoeWordPairs() {
  const supabaseUrl = process.env.VITE_SUPABASE_URL || process.env.SUPABASE_URL;
  const supabaseKey = process.env.SUPABASE_SERVICE_KEY || process.env.VITE_SUPABASE_ANON_KEY;

  if (!supabaseUrl || !supabaseKey) {
    console.error('Missing SUPABASE_URL or SUPABASE_SERVICE_KEY');
    console.error('Run: node --env-file=.env.local scripts/seed-moe-word-pairs.cjs');
    process.exit(1);
  }

  const supabase = createClient(supabaseUrl, supabaseKey);

  // Load extracted MOE pairs
  const dataPath = path.join(__dirname, '..', 'data', 'moe_word_pairs.json');
  if (!fs.existsSync(dataPath)) {
    console.error('MOE word pairs not found. Run extract-moe-word-pairs.cjs first.');
    process.exit(1);
  }

  const pairs = JSON.parse(fs.readFileSync(dataPath, 'utf-8'));
  console.log(`Loaded ${pairs.length} MOE word pairs`);

  // Check existing counts
  const { count: beforeCount } = await supabase
    .from('word_pairs')
    .select('*', { count: 'exact', head: true });

  const { count: ccccCount } = await supabase
    .from('word_pairs')
    .select('*', { count: 'exact', head: true })
    .not('category', 'is', null);

  console.log(`\nBefore seeding:`);
  console.log(`  Total word_pairs: ${beforeCount}`);
  console.log(`  CCCC pairs (category IS NOT NULL): ${ccccCount}`);
  console.log(`  MOE pairs (category IS NULL): ${(beforeCount || 0) - (ccccCount || 0)}`);

  // Prepare rows: category = null for all MOE pairs
  const toInsert = pairs.map(p => ({
    word: p.word,
    char1: p.char1,
    char2: p.char2,
    category: null
  }));

  // Batch upsert (100 at a time)
  const batchSize = 100;
  let inserted = 0;
  let skipped = 0;

  console.log(`\nInserting ${toInsert.length} MOE word pairs (ON CONFLICT DO NOTHING)...`);

  for (let i = 0; i < toInsert.length; i += batchSize) {
    const batch = toInsert.slice(i, i + batchSize);

    const { error, count } = await supabase
      .from('word_pairs')
      .upsert(batch, { onConflict: 'word', ignoreDuplicates: true, count: 'exact' });

    if (error) {
      console.error(`\nInsert failed at batch ${Math.floor(i / batchSize) + 1}:`, error);
      process.exit(1);
    }

    inserted += batch.length;
    process.stdout.write(`\r  Progress: ${inserted}/${toInsert.length}`);
  }

  console.log('\n');

  // Verify final counts
  const { count: afterCount } = await supabase
    .from('word_pairs')
    .select('*', { count: 'exact', head: true });

  const { count: afterCccc } = await supabase
    .from('word_pairs')
    .select('*', { count: 'exact', head: true })
    .not('category', 'is', null);

  const newMoe = (afterCount || 0) - (afterCccc || 0);
  const added = (afterCount || 0) - (beforeCount || 0);

  console.log(`=== RESULTS ===`);
  console.log(`  Total word_pairs: ${afterCount}`);
  console.log(`  CCCC pairs preserved: ${afterCccc}`);
  console.log(`  MOE pairs: ${newMoe}`);
  console.log(`  New rows added: ${added}`);

  // Spot-check the ambiguous words from Issue #34
  const { data: spotCheckData } = await supabase
    .from('word_pairs')
    .select('word, char1, char2, category')
    .in('word', ['日記', '日光', '小人', '小學', '這個', '這天', '太陽']);

  console.log(`\n=== SPOT CHECK (Issue #34 ambiguous words) ===`);
  for (const row of spotCheckData || []) {
    console.log(`  ✅ ${row.word} (${row.char1}+${row.char2}) [${row.category || 'MOE'}]`);
  }

  // Show high-ambiguity characters
  const { data: topChars } = await supabase
    .rpc('get_word_pair_conflict_set')
    .then(() => ({ data: null }))
    .catch(() => ({ data: null }));

  console.log('\n✅ Seeding complete!');
  console.log('Next: Run the RPC migration, then verify with get_word_pair_conflict_set()');
}

seedMoeWordPairs().catch(err => {
  console.error('Fatal error:', err);
  process.exit(1);
});
